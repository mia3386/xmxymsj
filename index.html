<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°è‹—å°ç¾Šè§…é£Ÿè®°
  </title>
  <meta name="description" content="å›ºå®šè¯„ä»·äººï¼ˆå°è‹—/å°ç¾Šï¼‰å¯¹é¤å…è¿›è¡Œç¯å¢ƒ/å£å‘³/æ€§ä»·æ¯”è¯„åˆ†ï¼ˆ1~5 å¯å°æ•°ï¼‰ï¼Œæ”¯æŒæ–°å¢/ç¼–è¾‘ã€æ‰¹é‡å¯¼å…¥å¯¼å‡ºã€æ¸…ç©ºæ•°æ®ã€å¯æŠ˜å é¤å…åˆ—è¡¨ã€æŒ‰åˆ—æ’åºä¸ä¸‰åˆ—Top10ç»´åº¦æ’åã€‚">
  <style>
    :root{
      --bg:#0d1320;
      --panel:#121930;
      --panel-2:#0f1630;
      --text:#e9edff;
      --muted:#93a0c6;
      --line:#2e3a62;
      --accent:#7aa2ff;
      --accent2:#9bffd1;
      --danger:#ff6b6b;
      --ok:#24d094;
      --blue:#7db1ff;
      --red:#ff6b6b;
      --radius:16px;
      --shadow:0 14px 36px rgba(0,0,0,.35);
      --fs-base:17px;
      --fs-lg:19px;
      --fs-xl:22.5px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1000px 520px at 80% -10%,#3556b333,transparent 60%),
        linear-gradient(180deg,#0b1126,#0a0f1f 60%);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans CJK SC","PingFang SC","Microsoft YaHei",sans-serif;
      font-size:var(--fs-base);
      line-height:1.6;
    }
    .wrap{max-width:1180px;margin:48px auto;padding:0 22px 80px}
    header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:22px;gap:14px;flex-wrap:wrap}
    h1{margin:0;font-weight:800;letter-spacing:.4px;font-size:clamp(24px,3.2vw,38px);
       background:linear-gradient(90deg,#a3ffd9,#86b6ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .sub{color:var(--muted);font-size:13px;margin:8px 0 0}
    .card{background:linear-gradient(180deg,var(--panel),#0f1839);border:1px solid var(--line);
          border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:18px}
    .card h2{font-size:var(--fs-lg);margin:0;padding:18px 18px 0}
    .body{padding:4px 18px 18px}
    .row{display:grid;grid-template-columns: repeat(2,1fr); gap:14px}
    .row-3{display:grid;grid-template-columns: repeat(3,1fr); gap:14px}
    .cols-3{display:grid;grid-template-columns:repeat(3,1fr); gap:16px}
    @media (max-width:980px){ .row,.row-3,.cols-3{ grid-template-columns:1fr } }
    label{font-size:13px;color:var(--muted);display:block;margin:10px 0 6px}
    input,select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:#0c1330;color:var(--text);outline:none;font-size:var(--fs-base)}
    input:focus,select:focus{box-shadow:0 0 0 3px #86b6ff44;border-color:#86b6ff66}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{appearance:none;border:1px solid #3a53aa;cursor:pointer;border-radius:14px;padding:12px 16px;font-weight:800;color:#0b1126;background:var(--accent);font-size:var(--fs-base)}
    button:hover{filter:brightness(1.06) saturate(1.08)}
    .outline{background:#0c1330;color:var(--text)}
    .danger{background:var(--danger);border-color:#ff5464;color:white}
    .ghost{background:#141c44;border:1px solid var(--line);color:var(--text)}
    .ok{background:var(--ok);border-color:#0000;color:#041712}
    .muted{color:var(--muted)}
    .table-wrap{overflow:auto;max-height:520px}
    table{width:100%;border-collapse:separate;border-spacing:0 12px;min-width:900px;font-size:var(--fs-base)}
    thead th{position:sticky;top:0;background:#0f1d52;padding:10px 12px;color:#dfe5ff;font-size:13px;text-align:left;user-select:none}
    thead th.sortable{cursor:pointer}
    thead th.sortable .arrow{opacity:.9;margin-left:6px;font-size:12px;color:#b7c5ff;font-weight:700}
    tbody td{background:#101a48;border:1px solid #364985;padding:12px}
    tbody tr td:first-child{border-radius:14px 0 0 14px}
    tbody tr td:last-child{border-radius:0 14px 14px 0}
    .op-btn{padding:8px 10px;border-radius:10px;background:#18245a;border:1px solid #455faa;color:#e7edff;font-weight:800}
    .op-btn:hover{border-color:#6480d1}
    .pair{font-weight:900}
    .pair .l{color:var(--red)}
    .pair .r{color:var(--blue)}
    .bar{height:16px;border-radius:999px;background:#263366;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#a3ffd9,#86b6ff)}
    .stat-badge{font-size:12.5px;padding:6px 10px;border-radius:999px;background:#0e1542;border:1px solid #3a4b80;display:inline-block;color:#e6ecff}
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(10px);bottom:24px;background:#0f1a46;border:1px solid var(--line);padding:12px 16px;border-radius:14px;opacity:0;transition:.25s;pointer-events:none}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .footer{color:var(--muted);font-size:12.5px;text-align:center;margin-top:12px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e132e;border:1px solid #3a4b80;border-radius:6px;padding:2px 6px;color:#e6ecff}
    .hint{font-size:12.5px;color:var(--muted)}
    .section-actions{display:flex;justify-content:space-between;align-items:center;padding:0 18px 6px}
    .section-actions .right{display:flex;gap:10px;align-items:center}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>å°è‹—å°ç¾Šè§…é£Ÿè®°</h1>
        <!-- <p class="sub">å›ºå®šè¯„ä»·äººï¼š<b>å°è‹—</b> & <b>å°ç¾Š</b>ã€‚æ—¥æœŸä½¿ç”¨ <b>yyyymmdd</b>ï¼ˆç¤ºä¾‹ï¼š20250811ï¼‰ã€‚</p> -->
      </div>
      <div class="actions">
        <button id="statBtn" class="ok">ç»Ÿè®¡ç»´åº¦æ’å</button>
        <button id="importBtn" class="ghost">å¯¼å…¥ JSON/Excel(CSV)</button>
        <button id="exportJsonBtn" class="ghost">å¯¼å‡º JSON</button>
        <button id="exportCsvBtn" class="ghost">å¯¼å‡º Excelï¼ˆCSVï¼‰</button>
        <button id="clearAllBtn" class="danger">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <input type="file" id="importFile" accept=".json,.csv" style="display:none" />
      </div>
    </header>

    <!-- æ–°å¢é¤å…ï¼ˆæ—¥æœŸå¿…å¡«ï¼Œ8ä½ yyyymmddï¼‰ -->
    <section class="card">
      <h2>æ–°å¢é¤å…</h2>
      <div class="body">
        <div class="row-3">
          <div>
            <label>æ—¥æœŸ</label>
            <input type="text" id="new_date" placeholder="20250811" inputmode="numeric" pattern="\d{8}" required>
          </div>
          <div>
            <label>é¤å…</label>
            <input id="new_name" type="text" placeholder="ä¾‹å¦‚ï¼šèœ€å‘³å°é¦† / Sushi Kazu">
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="createBtn" style="width:100%">æ·»åŠ é¤å…</button>
          </div>
        </div>
        <!-- <p class="hint">ä¹Ÿå¯å…ˆæ‰¹é‡å¯¼å…¥ï¼Œå†é€ä¸ªè¡¥è¯„åˆ†ã€‚</p> -->
      </div>
    </section>

    <!-- æ›´æ–°é¤å…è¯„åˆ†ï¼šå¯ç¼–è¾‘é¤å…åï¼›æ—¥æœŸåŒæ ·é‡‡ç”¨ yyyymmddï¼ˆéå¿…å¡«ï¼‰ -->
    <section class="card" id="updateCard" style="display:none">
      <div class="section-actions">
        <h2 style="padding:0;margin:0">é¤å…è¯„åˆ†</h2>
        <div class="right"><button id="cancelEdit" class="outline">å–æ¶ˆç¼–è¾‘</button></div>
      </div>
      <div class="body">
        <div class="row-3">
          <div>
            <label>é¤å…</label>
            <input id="upd_name" type="text" placeholder="è¯·è¾“å…¥é¤å…åç§°">
          </div>
          <div>
            <label>æ—¥æœŸ</label>
            <input type="text" id="upd_date" placeholder="20250811" inputmode="numeric" pattern="\d{8}">
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <div>
            <label style="font-weight:800">å°è‹— Â· è¯„åˆ†</label>
            <div class="row-3">
              <div><label>ç¯å¢ƒ</label><input type="number" id="a_env" step="0.1" min="1" max="5" placeholder="1-5"></div>
              <div><label>å£å‘³</label><input type="number" id="a_taste" step="0.1" min="1" max="5" placeholder="1-5"></div>
              <div><label>æ€§ä»·æ¯”</label><input type="number" id="a_value" step="0.1" min="1" max="5" placeholder="1-5"></div>
            </div>
          </div>
          <div>
            <label style="font-weight:800">å°ç¾Š Â· è¯„åˆ†</label>
            <div class="row-3">
              <div><label>ç¯å¢ƒ</label><input type="number" id="b_env" step="0.1" min="1" max="5" placeholder="1-5"></div>
              <div><label>å£å‘³</label><input type="number" id="b_taste" step="0.1" min="1" max="5" placeholder="1-5"></div>
              <div><label>æ€§ä»·æ¯”</label><input type="number" id="b_value" step="0.1" min="1" max="5" placeholder="1-5"></div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button id="saveScoreBtn">ä¿å­˜</button>
          <button id="resetScoreBtn" class="outline">æ¸…ç©ºæœ¬æ¬¡è¾“å…¥</button>
        </div>
        <!-- <p class="hint" id="editingHint">ä»ä¸‹æ–¹åˆ—è¡¨ç‚¹å‡»<strong>ç¼–è¾‘</strong>è¿›å…¥æ­¤å¤„ï¼›ä¿å­˜åæ­¤é¢æ¿è‡ªåŠ¨æ”¶èµ·ã€‚</p> -->
      </div>
    </section>

    <!-- é¤å…åˆ—è¡¨ï¼ˆæ— åºå·ï¼›æ—¥æœŸ/é¤å…å/ç»´åº¦åˆ—å‡å¯æ’åºï¼›å¯æŠ˜å ï¼‰ -->
    <section class="card">
      <div class="section-actions">
        <h2 style="padding:0;margin:0">é¤å…åˆ—è¡¨</h2>
        <div class="right">
          <button id="toggleListBtn" class="ghost">æŠ˜å åˆ—è¡¨</button>
        </div>
      </div>
      <div class="body table-wrap" id="listBody">
        <table>
          <thead>
            <tr>
              <th id="th_date" class="sortable nowrap" style="min-width:140px">æ—¥æœŸ <span class="arrow">â†•</span></th>
              <th id="th_name" class="sortable nowrap" style="min-width:220px">é¤å… <span class="arrow">â†•</span></th>
              <th id="th_env" class="sortable nowrap">ç¯å¢ƒï¼ˆå°è‹—/å°ç¾Šï¼‰ <span class="arrow">â†•</span></th>
              <th id="th_taste" class="sortable nowrap">å£å‘³ï¼ˆå°è‹—/å°ç¾Šï¼‰ <span class="arrow">â†•</span></th>
              <th id="th_value" class="sortable nowrap">æ€§ä»·æ¯”ï¼ˆå°è‹—/å°ç¾Šï¼‰ <span class="arrow">â†•</span></th>
              <th class="nowrap">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- ç»´åº¦æ’åï¼ˆä¸‰åˆ—Top10 + æ˜¾ç¤ºå…¨éƒ¨ï¼‰ -->
    <section class="card">
      <div class="section-actions">
        <h2 style="padding:0;margin:0">ç»´åº¦æ’åï¼ˆTop 10ï¼‰</h2>
        <div class="right">
          <button id="toggleRanksBtn" class="ghost">æ˜¾ç¤ºå…¨éƒ¨æ’è¡Œ</button>
          <span id="countInfo" class="stat-badge">å½“å‰é¤å…ï¼š0</span>
        </div>
      </div>
      <div class="body" id="stats" style="display:none">
        <div class="cols-3">
          <div>
            <h3 style="margin:10px 0;font-size:var(--fs-lg)">ğŸ† ç¯å¢ƒ</h3>
            <div id="rank_env"></div>
          </div>
          <div>
            <h3 style="margin:10px 0;font-size:var(--fs-lg)">ğŸœ å£å‘³</h3>
            <div id="rank_taste"></div>
          </div>
          <div>
            <h3 style="margin:10px 0;font-size:var(--fs-lg)">ğŸ’° æ€§ä»·æ¯”</h3>
            <div id="rank_value"></div>
          </div>
        </div>
      </div>
      <div class="section-actions" style="padding-top:0">
        <div></div>
        <div class="right"><button id="statBtn2" class="ok">ç»Ÿè®¡å¹¶å±•ç¤º</button></div>
      </div>
    </section>

    <!-- <p class="footer">å¿«æ·é”®ï¼š<span class="kbd">Ctrl / âŒ˜ + Enter</span> åœ¨â€œæ›´æ–°é¤å…è¯„åˆ†â€é‡Œä¿å­˜ï¼›<span class="kbd">Esc</span> æ¸…ç©ºå½“å‰è¯„åˆ†è¾“å…¥ã€‚</p> -->
  </div>

  <div class="toast" id="toast">å·²ä¿å­˜</div>

  <script>
    // ===== å·¥å…·/çŠ¶æ€ =====
    const KEY='xmxy_v7'; // æ²¿ç”¨ï¼Œä»¥ä¿ç•™ä½ çš„ç°æœ‰æ•°æ®
    const $=(q,r=document)=>r.querySelector(q);
    const $$=(q,r=document)=>[...r.querySelectorAll(q)];
    const toast=(m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600)};
    const state={ entries:[], editingId:null, sort:{key:null,dir:'desc'}, ranksShowAll:false, listCollapsed:false };

    // æ—¥æœŸå½’ä¸€ï¼š8 ä½ yyyymmdd
    function normalizeDate8(s){
      if(!s) return '';
      const digits = String(s).replace(/\D/g,'');
      if(digits.length===8) return digits;
      if(digits.length===6){ return '20'+digits; }
      return '';
    }
    function isValidDate8(s){
      if(!/^\d{8}$/.test(s)) return false;
      const y=+s.slice(0,4), m=+s.slice(4,6), d=+s.slice(6,8);
      if(m<1||m>12||d<1||d>31) return false;
      return true;
    }
    function toSortNumber8(s){ return /^\d{8}$/.test(s) ? +s : -1; }

    function load(){
      try{
        const raw=localStorage.getItem(KEY);
        if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)) state.entries=arr; }
      }catch(_){}
      state.entries.forEach(it=>{ it.date = normalizeDate8(it.date); });
      save();
      renderTable(); updateCount();
    }
    function save(){ localStorage.setItem(KEY, JSON.stringify(state.entries)) }
    function updateCount(){ $('#countInfo').textContent='å½“å‰é¤å…ï¼š'+state.entries.length }

    const numOk = v => typeof v==='number' && !Number.isNaN(v);
    const validScore = v => numOk(v) && v>=1 && v<=5;
    const fmt1 = v => numOk(v) ? Number(v).toFixed(1) : '-';

    // ===== æ–°å¢é¤å… =====
    function createRestaurant(){
      const name = $('#new_name').value.trim();
      const dateRaw = $('#new_date').value.trim();
      if(!name){ toast('è¯·å¡«å†™é¤å…åç§°'); return; }
      const d8 = normalizeDate8(dateRaw);
      if(!isValidDate8(d8)){ toast('è¯·æŒ‰ yyyymmdd å¡«å†™æœ‰æ•ˆæ—¥æœŸ'); return; }
      const rec = { id: Date.now().toString(36)+Math.random().toString(36).slice(2,7), name, date:d8,
                    a:{env:null,taste:null,value:null},
                    b:{env:null,taste:null,value:null} };
      state.entries.push(rec); save(); renderTable();
      $('#new_name').value=''; $('#new_date').value='';
      updateCount();
      toast('å·²æ·»åŠ é¤å…ï¼š'+name);
    }

    // ===== æ›´æ–°é¤å…è¯„åˆ†ï¼ˆå…è®¸å…¨éƒ¨ç•™ç©ºï¼›ç•™ç©º=æ¸…é™¤è¯¥é¡¹åˆ†æ•°ï¼‰ =====
    function openEditor(id){
      const it = state.entries.find(x=>x.id===id); if(!it) return;
      state.editingId = id;
      $('#updateCard').style.display='block';
      $('#upd_name').value = it.name;
      $('#upd_date').value = it.date || '';
      $('#a_env').value = (numOk(it.a.env)? it.a.env : '');
      $('#a_taste').value = (numOk(it.a.taste)? it.a.taste : '');
      $('#a_value').value = (numOk(it.a.value)? it.a.value : '');
      $('#b_env').value = (numOk(it.b.env)? it.b.env : '');
      $('#b_taste').value = (numOk(it.b.taste)? it.b.taste : '');
      $('#b_value').value = (numOk(it.b.value)? it.b.value : '');
      // $('#editingHint').innerHTML = 'æ­£åœ¨ç¼–è¾‘ï¼š<b>'+ it.name +'</b>ï¼ˆç•™ç©º=æ¸…é™¤è¯¥é¡¹ï¼›æ—¥æœŸç”¨ yyyymmddï¼‰';
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function resetScoreInputs(){
      ['a_env','a_taste','a_value','b_env','b_taste','b_value'].forEach(id=>$('#'+id).value='');
    }
    function saveScores(){
      if(!state.editingId){ toast('è¯·å…ˆä»åˆ—è¡¨ç‚¹å‡»â€œç¼–è¾‘â€'); return; }
      const it = state.entries.find(x=>x.id===state.editingId); if(!it) return;
      // åç§°
      const newName = $('#upd_name').value.trim();
      if(!newName){ toast('é¤å…åä¸èƒ½ä¸ºç©º'); return; }
      it.name = newName;
      // æ—¥æœŸï¼ˆå¯é€‰ï¼‰
      const dateInput = $('#upd_date').value.trim();
      if(dateInput){
        const d8 = normalizeDate8(dateInput);
        if(!isValidDate8(d8)){ toast('æ—¥æœŸéœ€ä¸º yyyymmdd'); return; }
        it.date = d8;
      }
      // è¯„åˆ†ï¼šç•™ç©º => æ¸…é™¤ï¼ˆè®¾ä¸º nullï¼‰
      function toNumOrNull(v){
        const s=String(v??'').trim();
        if(s==='') return null;
        const n=Number(s);
        if(Number.isNaN(n) || n<1 || n>5){ toast('åˆ†æ•°éœ€åœ¨ 1~5 ä¹‹é—´'); throw new Error('bad'); }
        return n;
      }
      try{
        it.a.env = toNumOrNull($('#a_env').value);
        it.a.taste = toNumOrNull($('#a_taste').value);
        it.a.value = toNumOrNull($('#a_value').value);
        it.b.env = toNumOrNull($('#b_env').value);
        it.b.taste = toNumOrNull($('#b_taste').value);
        it.b.value = toNumOrNull($('#b_value').value);
      }catch(e){ return; }
      save(); renderTable(); toast('å·²ä¿å­˜');
      cancelEdit(); // è‡ªåŠ¨æ”¶èµ·
    }
    function cancelEdit(){ state.editingId=null; $('#updateCard').style.display='none'; resetScoreInputs(); }

    // ===== æ’åºè¾…åŠ© =====
    function getAvg(it, key){
      const a = it.a[key], b = it.b[key];
      const aOk=validScore(a), bOk=validScore(b);
      if(aOk && bOk) return (a+b)/2;
      if(aOk) return a - 0.001;
      if(bOk) return b - 0.001;
      return null;
    }
    function sortedEntries(){
      const {key,dir} = state.sort;
      const list = [...state.entries];
      if(!key) return list;
      const mul = dir==='asc' ? 1 : -1;
      if(key==='name'){
        return list.sort((x,y)=> (x.name||'').localeCompare(y.name||'', 'zh-Hans') * mul);
      }
      if(key==='date'){
        return list.sort((x,y)=> (toSortNumber8(x.date) - toSortNumber8(y.date)) * mul);
      }
      return list.sort((x,y)=>{
        const ax=getAvg(x,key), ay=getAvg(y,key);
        if(ax===null && ay===null) return 0;
        if(ax===null) return 1;
        if(ay===null) return -1;
        if(ax===ay) return 0;
        return (ax>ay?1:-1)*mul;
      });
    }
    function setSort(key){
      if(state.sort.key===key){
        state.sort.dir = (state.sort.dir==='desc' ? 'asc' : 'desc');
      }else{
        state.sort.key = key;
        state.sort.dir = (key==='name'||key==='date') ? 'asc' : 'desc';
      }
      renderTable();
      $$('#th_env, #th_taste, #th_value, #th_date, #th_name').forEach(th=> th.querySelector('.arrow').textContent='â†•');
      const th = key==='env'?$('#th_env'):key==='taste'?$('#th_taste'):key==='value'?$('#th_value'):key==='date'?$('#th_date'):$('#th_name');
      th.querySelector('.arrow').textContent = state.sort.dir==='desc' ? 'â†“' : 'â†‘';
    }

    // ===== åˆ—è¡¨æ¸²æŸ“ =====
    function renderTable(){
      const tb=$('#tbody'); tb.innerHTML='';
      const data = sortedEntries();
      data.forEach((it)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${it.date||''}</td>
          <td>${it.name}</td>
          <td class="pair"><span class="l">${fmt1(it.a.env)}</span>/<span class="r">${fmt1(it.b.env)}</span></td>
          <td class="pair"><span class="l">${fmt1(it.a.taste)}</span>/<span class="r">${fmt1(it.b.taste)}</span></td>
          <td class="pair"><span class="l">${fmt1(it.a.value)}</span>/<span class="r">${fmt1(it.b.value)}</span></td>
          <td style="display:flex;gap:10px">
            <button class="op-btn" data-act="edit" data-id="${it.id}">ç¼–è¾‘</button>
            <button class="op-btn" data-act="del" data-id="${it.id}">åˆ é™¤</button>
          </td>`;
        tb.appendChild(tr);
      });
      updateCount();
    }

    // ===== åˆ—è¡¨äº‹ä»¶ =====
    $('#tbody').addEventListener('click',(e)=>{
      const btn=e.target.closest('button[data-act]'); if(!btn) return;
      const id=btn.dataset.id; const act=btn.dataset.act;
      const it=state.entries.find(x=>x.id===id); if(!it) return;
      if(act==='edit'){ openEditor(id); }
      else if(act==='del'){
        if(confirm('ç¡®è®¤åˆ é™¤ã€Œ'+it.name+'ã€ï¼Ÿ')){
          state.entries=state.entries.filter(x=>x.id!==id); save(); renderTable(); if(state.editingId===id) cancelEdit(); toast('å·²åˆ é™¤');
        }
      }
    });

    // ===== å¯æŠ˜å åˆ—è¡¨ =====
    $('#toggleListBtn').addEventListener('click',()=>{
      state.listCollapsed = !state.listCollapsed;
      $('#listBody').style.display = state.listCollapsed ? 'none' : 'block';
      $('#toggleListBtn').textContent = state.listCollapsed ? 'å±•å¼€åˆ—è¡¨' : 'æŠ˜å åˆ—è¡¨';
    });

    // ===== ç»´åº¦æ’å =====
    function computeStats(){
      const rows = state.entries.map(it=>{
        const env = (validScore(it.a.env) && validScore(it.b.env)) ? (it.a.env+it.b.env)/2 : null;
        const taste = (validScore(it.a.taste) && validScore(it.b.taste)) ? (it.a.taste+it.b.taste)/2 : null;
        const value = (validScore(it.a.value) && validScore(it.b.value)) ? (it.a.value+it.b.value)/2 : null;
        return {name:it.name, env, taste, value};
      });
      return {
        env: rows.filter(r=>numOk(r.env)).sort((a,b)=>b.env-a.env),
        taste: rows.filter(r=>numOk(r.taste)).sort((a,b)=>b.taste-a.taste),
        value: rows.filter(r=>numOk(r.value)).sort((a,b)=>b.value-a.value),
      };
    }
    function renderRanks(){
      const s=computeStats();
      const make=(arr,rootId,field)=>{
        const root=$('#'+rootId); root.innerHTML='';
        const list = state.ranksShowAll ? arr : arr.slice(0,10);
        list.forEach((r,i)=>{
          const idx = i+1;
          const pct=(r[field]/5*100).toFixed(1);
          const row=document.createElement('div'); row.style.margin='10px 0';
          row.innerHTML=`
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
              <span class="stat-badge">#${idx}</span>
              <div style="min-width:180px">${r.name}</div>
              <div class="muted" style="font-size:13px">${r[field].toFixed(2)} / 5</div>
            </div>
            <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
          `;
          root.appendChild(row);
        });
        if(!state.ranksShowAll && arr.length>10){
          const more = document.createElement('div');
          more.className='hint';
          more.textContent = `â€¦â€¦ å…± ${arr.length} å®¶ï¼Œå½“å‰æ˜¾ç¤º Top 10`;
          root.appendChild(more);
        }
      };
      make(s.env,'rank_env','env');
      make(s.taste,'rank_taste','taste');
      make(s.value,'rank_value','value');
      $('#stats').style.display='block';
      const y=$('#stats').getBoundingClientRect().top + window.scrollY - 10;
      window.scrollTo({top:y,behavior:'smooth'});
    }

    // ===== å¯¼å‡º =====
    function exportJSON(){
      const blob=new Blob([JSON.stringify(state.entries,null,2)],{type:'application/json;charset=utf-8'});
      download(blob,'å°è‹—å°ç¾Šè§…é£Ÿè®°-æ•°æ®.json');
    }
    function exportCSV(){
      const rows=[];
      rows.push(['æ—¥æœŸ(yyyymmdd)','é¤å…','å°è‹—Â·ç¯å¢ƒ','å°è‹—Â·å£å‘³','å°è‹—Â·æ€§ä»·æ¯”','å°ç¾ŠÂ·ç¯å¢ƒ','å°ç¾ŠÂ·å£å‘³','å°ç¾ŠÂ·æ€§ä»·æ¯”','ç¯å¢ƒå‡åˆ†','å£å‘³å‡åˆ†','æ€§ä»·æ¯”å‡åˆ†']);
      state.entries.forEach(it=>{
        const envAvg = (validScore(it.a.env) && validScore(it.b.env)) ? ((it.a.env+it.b.env)/2).toFixed(2) : '';
        const tasteAvg = (validScore(it.a.taste) && validScore(it.b.taste)) ? ((it.a.taste+it.b.taste)/2).toFixed(2) : '';
        const valueAvg = (validScore(it.a.value) && validScore(it.b.value)) ? ((it.a.value+it.b.value)/2).toFixed(2) : '';
        rows.push([it.date||'', it.name, fmt1(it.a.env), fmt1(it.a.taste), fmt1(it.a.value), fmt1(it.b.env), fmt1(it.b.taste), fmt1(it.b.value), envAvg, tasteAvg, valueAvg]);
      });
      const csv=rows.map(r=>r.map(s=>{
        const t=String(s??''); return /[",\n]/.test(t)?('"'+t.replace(/"/g,'""')+'"'):t;
      }).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
      download(blob,'å°è‹—å°ç¾Šè§…é£Ÿè®°-Excel.csv');
    }
    function download(blob,filename){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove()},0);
      toast('å·²å¯¼å‡ºï¼š'+filename);
    }

    // ===== æ¸…ç©ºå…¨éƒ¨ =====
    function clearAll(){
      if(!state.entries.length){ toast('æ²¡æœ‰å¯æ¸…ç©ºçš„æ•°æ®'); return; }
      const ok = confirm('âš ï¸ å°†æ¸…ç©ºæœ¬åœ°ä¿å­˜çš„æ‰€æœ‰é¤å…ä¸è¯„åˆ†ï¼Œä¸”ä¸å¯æ¢å¤ã€‚\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
      if(!ok) return;
      state.entries = [];
      save(); renderTable(); cancelEdit(); updateCount();
      toast('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®');
    }

    // ===== å¯¼å…¥ï¼ˆJSON / CSVï¼‰ =====
    function handleImportFile(file){
      const name = (file.name||'').toLowerCase();
      const isJSON = name.endsWith('.json');
      const reader = new FileReader();
      reader.onload = (e)=>{
        const text = e.target.result;
        try{
          let imported=[];
          if(isJSON || (!text.includes(',') && text.trim().startsWith('['))){
            imported = importFromJSON(text);
          }else{
            imported = importFromCSV(text);
          }
          if(!imported.length){ toast('æœªè¯†åˆ«åˆ°æœ‰æ•ˆæ•°æ®'); return; }
          const replace = confirm(`å°†å¯¼å…¥ ${imported.length} æ¡è®°å½•ã€‚\nç¡®å®š=æ¸…ç©ºå¹¶æ›¿æ¢ï¼›å–æ¶ˆ=åœ¨ç°æœ‰æ•°æ®ä¸Šè¿½åŠ /è¦†ç›–é‡å¤é¡¹ã€‚`);
          if(replace){
            state.entries = imported;
          }else{
            const map = new Map(state.entries.map(it=>[it.name+'|'+(it.date||''), it]));
            imported.forEach(it=> map.set(it.name+'|'+(it.date||''), it));
            state.entries = Array.from(map.values());
          }
          save(); renderTable(); updateCount();
          toast('å¯¼å…¥å®Œæˆ');
        }catch(err){
          console.error(err);
          toast('å¯¼å…¥å¤±è´¥ï¼š'+ (err.message||'æ ¼å¼é”™è¯¯'));
        }
      };
      reader.readAsText(file,'utf-8');
    }

    function importFromJSON(text){
      const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('JSON é¡¶å±‚åº”ä¸ºæ•°ç»„');
      const out=[];
      arr.forEach(obj=>{
        if(!obj) return;
        const name = (obj.name||obj['é¤å…']||obj['é¤å…åç§°']||obj['é¤å…å']||'').trim();
        const date = normalizeDate8(obj.date||obj['æ—¥æœŸ']||obj['æ—¥æœŸ(yyyymmdd)']||obj['date']||'');
        if(!name) return;
        const a = obj.a || {};
        const b = obj.b || {};
        function n(v){ if(v===null||v===undefined||v==='') return null; const x=Number(v); return Number.isFinite(x)&&x>=1&&x<=5?x:null; }
        const rec = {
          id: Date.now().toString(36)+Math.random().toString(36).slice(2,7),
          name,
          date: isValidDate8(date)? date : '',
          a:{ env: n(a.env ?? obj.a_env ?? obj['å°è‹—Â·ç¯å¢ƒ']), taste: n(a.taste ?? obj.a_taste ?? obj['å°è‹—Â·å£å‘³']), value: n(a.value ?? obj.a_value ?? obj['å°è‹—Â·æ€§ä»·æ¯”']) },
          b:{ env: n(b.env ?? obj.b_env ?? obj['å°ç¾ŠÂ·ç¯å¢ƒ']), taste: n(b.taste ?? obj.b_taste ?? obj['å°ç¾ŠÂ·å£å‘³']), value: n(b.value ?? obj.b_value ?? obj['å°ç¾ŠÂ·æ€§ä»·æ¯”']) },
        };
        out.push(rec);
      });
      return out;
    }

    function parseCSV(text){
      const rows=[]; let cur='', row=[], inQ=false;
      const pushCell=()=>{ row.push(cur); cur=''; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      for(let i=0;i<text.length;i++){
        const ch=text[i];
        if(inQ){
          if(ch==='\"'){
            if(text[i+1]==='\"'){ cur+='\"'; i++; } else { inQ=false; }
          } else { cur+=ch; }
        }else{
          if(ch==='\"'){ inQ=true; }
          else if(ch===','){ pushCell(); }
          else if(ch==='\n'){ pushCell(); pushRow(); }
          else if(ch==='\r'){}
          else { cur+=ch; }
        }
      }
      if(cur!=='' || row.length){ pushCell(); pushRow(); }
      if(rows.length && rows[0].length){ rows[0][0]=rows[0][0].replace(/^\uFEFF/,''); }
      return rows;
    }

    function importFromCSV(text){
      const rows = parseCSV(text);
      if(rows.length<2) throw new Error('CSV è‡³å°‘éœ€è¦è¡¨å¤´ä¸ä¸€è¡Œæ•°æ®');
      const header = rows[0].map(h=>h.trim());
      const idx = (names)=>{
        for(const n of names){ const k=header.findIndex(h=>h===n); if(k!==-1) return k; }
        return -1;
      };
      const iDate = idx(['æ—¥æœŸ','æ—¥æœŸ(yyyymmdd)','date','Date']);
      const iName = idx(['é¤å…','é¤å…åç§°','é¤å…å','name','Name']);
      const iAE = idx(['å°è‹—Â·ç¯å¢ƒ','a_env','a.env','aEnv']);
      const iAT = idx(['å°è‹—Â·å£å‘³','a_taste','a.taste','aTaste']);
      const iAV = idx(['å°è‹—Â·æ€§ä»·æ¯”','a_value','a.value','aValue']);
      const iBE = idx(['å°ç¾ŠÂ·ç¯å¢ƒ','b_env','b.env','bEnv']);
      const iBT = idx(['å°ç¾ŠÂ·å£å‘³','b_taste','b.taste','bTaste']);
      const iBV = idx(['å°ç¾ŠÂ·æ€§ä»·æ¯”','b_value','b.value','bValue']);
      if(iName===-1) throw new Error('ç¼ºå°‘â€œé¤å…/é¤å…åç§°/nameâ€ç­‰åˆ—');
      const out=[];
      for(let r=1;r<rows.length;r++){
        const cells = rows[r];
        if(cells.every(c=>String(c||'').trim()==='')) continue;
        const name = (cells[iName]||'').trim();
        if(!name) continue;
        const date = normalizeDate8(iDate===-1?'':cells[iDate]);
        function n(i){ if(i===-1) return null; const s=String(cells[i]??'').trim(); const x=Number(s); return Number.isFinite(x)&&x>=1&&x<=5?x:null; }
        const rec = {
          id: Date.now().toString(36)+Math.random().toString(36).slice(2,7),
          name,
          date: isValidDate8(date)? date : '',
          a:{ env:n(iAE), taste:n(iAT), value:n(iAV) },
          b:{ env:n(iBE), taste:n(iBT), value:n(iBV) },
        };
        out.push(rec);
      }
      return out;
    }

    // äº‹ä»¶
    $('#createBtn').addEventListener('click',createRestaurant);
    $('#saveScoreBtn').addEventListener('click',saveScores);
    $('#resetScoreBtn').addEventListener('click',resetScoreInputs);
    $('#cancelEdit').addEventListener('click',cancelEdit);
    $('#statBtn').addEventListener('click',renderRanks);
    $('#statBtn2').addEventListener('click',renderRanks);
    $('#exportJsonBtn').addEventListener('click',exportJSON);
    $('#exportCsvBtn').addEventListener('click',exportCSV);
    $('#th_env').addEventListener('click',()=>setSort('env'));
    $('#th_taste').addEventListener('click',()=>setSort('taste'));
    $('#th_value').addEventListener('click',()=>setSort('value'));
    $('#th_date').addEventListener('click',()=>setSort('date'));
    $('#th_name').addEventListener('click',()=>setSort('name'));
    $('#toggleRanksBtn').addEventListener('click',()=>{
      state.ranksShowAll = !state.ranksShowAll;
      $('#toggleRanksBtn').textContent = state.ranksShowAll ? 'åªçœ‹å‰10' : 'æ˜¾ç¤ºå…¨éƒ¨æ’è¡Œ';
      renderRanks();
    });
    document.addEventListener('keydown',(e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ if($('#updateCard').style.display!=='none') saveScores(); }
      if(e.key==='Escape'){ resetScoreInputs(); }
    });
    $('#clearAllBtn').addEventListener('click',clearAll);
    $('#importBtn').addEventListener('click',()=> $('#importFile').click());
    $('#importFile').addEventListener('change',(e)=>{
      const f=e.target.files && e.target.files[0];
      if(!f) return;
      handleImportFile(f);
      e.target.value='';
    });

    // å¯åŠ¨
    load();
  </script>
</body>
</html>
